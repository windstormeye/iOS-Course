## 用户态与核心态

### 用户态与核心态是什么？
将内核程序和基于内核程序之上构建的用户程序分开处理，使其分别运行在用户态和核心态

### 为什么需要用户态和核心态？
在CPU的所有指令中，有一些指令是非常危险的（不是`rm -rf`这种），如果错用，将导致整个系统奔溃，比如：清空内存，修改时钟等。如果所有的程序代码都能够直接使用这些指令，那么很有可能我们的系统一天将会死n次。

所以，CPU将指令分为 **特权指令** 和 **非特权指令** ，对于较为危险的指令，只允许操作系统本身及其相关模块进行调用，普通的、用户自行编写的应用程序只能使用那些不会造成危险的指令。intel的CPU将指令级别分为了4个等级，分别是：`RING0`, `RING1`, `RING2`, `RING3`。

当一个程序或一个任务（进程）执行系统调用而陷入内核代码中执行时，我们就称该程序、该任务处于内核态，此时处理器处于特权级别最高的`RING0`内核代码中执行，当进程处于内核态时，执行的内核代码将会使用该进程的内核栈，每个进程都拥有自己的内核栈。

当程序、进程在执行用户自己的代码时，我们就称该程序、该进程处在用户态，此时处理器处在特权级别最低的`RING3`用户代码中运行。

当正在执行用户程序而突然被中断程序（被打断了），此时用户程序也可以象征性的称为处于核心态，因为中断处理程序将使用当前进程的内核栈。

CPU总是处于以下状态中的一种：
* 内核态：运行于进程上下文，内核代表进程运行于内核空间；
* 内核态：运行于中断上下文，内核代表硬件运行于内核空间；
* 用户态：运行于用户空间。

### 什么是系统调用？
处在用户空间的应用程序，通过系统调用，进入内核空间。此时用户空间的进程要传递很多变量、参数给内核，内核态运行的时候也要保存用户进程的一些寄存器值、变量等等。所谓的“进程上下文”，就是用户进程传递给内核的参数以及内核要保存的那一整套变量、寄存器值和当时的环境等。比如`fork()`开启一个新的进程。

### 什么是中断程序？
硬件通过触发信号，导致内核调用中断处理程序，进入内核的空间。在这个过程中，硬件的一些变量和参数也要传递给内核，内核通过这些参数进行中断处理。所谓的“中断上下文”，其实也可以看做就是硬件传递的参数和内核需要保存的一些其它环境信息（被打断执行的进程环境）。

### 什么是内核？
操作系统大致经历了无结构操作系统（第一代）、模块化操作系统（第二代）、分层式操作系统（第三代），它们操作系统被称为“传统操作系统结构”，而单内核和微内核是目前“线代操作系统结构”中最重要的两个。比如Linux是单内核，windows和macOS都是微内核的。

操作系统的内核作用是对软件、硬件资源的管理。内核的最重要的一个作用就是实现任务调度，让计算机的资源被均衡的调度。如果一个操作系统没有内核，那么所有的任务（进程）都是完全独占计算机的，聊天的同时不能刷浏览器。

没有操作系统的内核，内存的动态管理也不存在了，后果就是可能没有虚拟内存，也就是说，如果此时运行的程序需要占用内存2G，但此时计算机只有1G内存，这个程序就跑不起来了。同时，设备的管理功能也就不存在了，比如动态设备的插拔（U盘）等等，而且计算机启动的时间会将会非常漫长，因为需要检测并加载各种驱动。

没有操作系统内核，多线程的操作都不能支持，因为信号量、消息队列这些都是操作系统提供的，所以如果真的把操作系统的内核剔除掉，现在大部分应用程序都要彻底重写来支持无内核的操作系统。并且多核CPU也发挥不了作用。

早期的操作系统有些游戏和软件就是直接拿软盘启动，是因为那时操作系统很小、功能弱、系统资源紧缺，没有什么内核也是OK的，但是现在计算机的硬件资源非常丰富，操作系统很庞大，没有内核进行统一管理的话，要么太浪费要么这个应用程序的负担（要处理的事情）会很重。

### 什么是虚拟内存？
以下内容摘自wiki，我没理解好虚拟内存的大概实现思路，先把wiki的结果放在着：
```
虚拟内存是电脑系统内存管理的一种技术。它使得应用程序认为它拥有连续可用的内存（一个连续完整的地址空间），而实际上，它通常是被分隔成多个物理内存碎片，还有部分暂时存储在外部磁盘存储器上，在需要时进行数据交换。与没有使用虚拟内存技术的系统相比，使用这种技术的系统使得大型程序的编写变得更容易，对真正的物理内存（例如RAM）的使用也更有效率。

注意：虚拟内存不只是“用磁盘空间来扩展物理内存”的意思——这只是扩充内存级别以使其包含硬盘驱动器而已。把内存扩展到磁盘只是使用虚拟内存技术的一个结果，它的作用也可以通过覆盖或者把处于不活动状态的程序以及它们的数据全部交换到磁盘上等方式来实现。对虚拟内存的定义是基于对地址空间的重定义的，即把地址空间定义为“连续的虚拟内存地址”，以借此“欺骗”程序，使它们以为自己正在使用一大块的“连续”地址。

现代所有用于一般应用的操作系统都对普通的应用程序使用虚拟内存技术，例如文字处理软件，电子制表软件，多媒体播放器等等。老一些的操作系统，如DOS和1980年代的Windows，或者那些1960年代的大型机，一般都没有虚拟内存的功能——但是Atlas，B5000和苹果公司的Lisa都是很值得注意的例外。[1]

那些需要快速访问或者反应时间非常一致的嵌入式系统，和其他的具有特殊应用的电脑系统，可能会为了避免让运算结果的可预测性降低，而选择不使用虚拟内存。
```
在Linux中用户进程空间和内核进程控件占用的虚拟内存比例为3：1。32位机虚拟内存最高2^32 = 4 GB，64位机虚拟内存最高2^64 ≈ 16000 PB。

### 计算机启动，检测并加载各种驱动
差一篇讲计算器启动全流程的讲解。

### 中间件
中间件的概念挺容易理解，就是整体来看要把分布式集群之间联系起来，业界一直在发布新的轮子，知乎这篇文章供参考：[https://www.zhihu.com/question/19730582](https://www.zhihu.com/question/19730582)

### 并发和并行
引用：[https://www.zhihu.com/question/33515481](https://www.zhihu.com/question/33515481)
```
你吃饭吃到一半，电话来了，你一直到吃完了以后才去接，这就说明你不支持并发也不支持并行。
你吃饭吃到一半，电话来了，你停了下来接了电话，接完后继续吃饭，这说明你支持并发。
你吃饭吃到一半，电话来了，你一边打电话一边吃饭，这说明你支持并行。

并发的关键是你有处理多个任务的能力，不一定要同时。并行的关键是你有同时处理多个任务的能力。所以我认为它们最关键的点就是：是否是『同时』。
```

### 生产者消费者模式
找到一篇讲解得比较细致的文章，但是文章本身内容太长，不易于总结，但实际上前后语义又通畅，就不做摘要了，原文链接：[https://www.jianshu.com/p/0d1c950e6614](https://www.jianshu.com/p/0d1c950e6614)

### C10K问题
留给自己以后看，这个问题不是目前自己需要考虑的。[https://blog.csdn.net/yeasy/article/details/43152115](https://blog.csdn.net/yeasy/article/details/43152115)







